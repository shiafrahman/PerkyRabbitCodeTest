<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Certificate</title>


    <script src="jspdf/jspdf.umd.js"></script>
    <script src="jspdf/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.debug.js"></script>






    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">


    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">



</head>
<body>
    <div class="container mt-4">
        <div class="col text-center">
            <h1>Employee Certificate</h1>
        </div>

       


        <div id="addEmployeeForm" class="mb-4">
            <div class="col text-center">
                <h2>Add/Edit Certificate</h2>
            </div>
            <form id="createForm">
                <input type="hidden" id="employeeId" value="">

                <div class="form-group">
                    <label for="employeeName">Name:</label>
                    <input type="text" class="form-control" id="employeeName" required>
                </div>

                <div class="form-group">
                    <label for="employeeSalary">Salary:</label>
                    <input type="text" class="form-control" id="employeeSalary" required>
                </div>

                <div class="form-group">
                    <label for="employeeDpt">Select Department:</label>
                    <select class="form-control" id="employeeDpt" required></select>
                </div>

                
                
                <div class="form-group">
                    <a href="Adddate.html" class="btn-group-sm">Add Date</a>
                        <label for="cDate"> Select Date:</label>
                        <select class="form-control" id="cDate" required>
                        </select>

                 </div>

                <div class="col text-center">
                    <button type="submit" class="btn btn-success" id="saveButton"><i class="fa-solid fa-floppy-disk"></i> SAVE</button>
                    <button type="button" class="btn btn-secondary" id="clearButton"><i class="fa-regular fa-circle-xmark"></i> Clear</button>
                </div>
            </form>
        </div>

        <div class="mb-4">
            <input type="text" id="searchInput" placeholder="Search by employee name">
            <button class="btn btn-primary" id="searchButton">Search</button>
        </div>

        <div class="table-responsive">

            <table id="employeeTable" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Salary</th>
                        <th>Department</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>


    </div>



    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>





    <script>


        var dataTable;

        $(document).ready(function () {



            function populateDropdown(dropdownId, apiUrl) {
                $.ajax({
                    url: apiUrl,
                    type: 'GET',
                    success: function (data) {
                        console.log('API Response:', data);

                        var dropdown = $('#' + dropdownId);
                        dropdown.empty();

                        // Check if the data is an array and has length
                        if (Array.isArray(data) && data.length > 0) {
                            // Assuming each item has 'id' and 'deptName' properties
                            data.forEach(function (item) {
                                dropdown.append($('<option></option>').attr('value', item.id).text(item.deptName));
                            });

                            console.log('Dropdown populated successfully.');
                            
                        } else {
                            console.error('Invalid data structure or empty response.');
                        }
                    },
                    error: function (error) {
                        console.error(error);
                    }
                });
            }

            function populateDropdownone(dropdownId, apiUrl) {
                $.ajax({
                    url: apiUrl,
                    type: 'GET',
                    success: function (data) {
                        console.log('API Response:', data);

                        var dropdown = $('#' + dropdownId);
                        dropdown.empty();

                        
                        if (Array.isArray(data) && data.length > 0) {
                            
                            data.forEach(function (item) {
                                dropdown.append($('<option></option>').attr('value', item.id).text(item.date));
                            });

                            console.log('Dropdown populated successfully.');
                        } else {
                            console.error('Invalid data structure or empty response.');
                        }
                    },
                    error: function (error) {
                        console.error(error);
                    }
                });
            }


            populateDropdown('employeeDpt', 'http://localhost:5251/api/Department');


            populateDropdownone('cDate', 'http://localhost:5251/api/Certificate');

     


            dataTable = $('#employeeTable').DataTable({
                "ajax": {
                    "url": "http://localhost:5251/api/Employee",
                    "dataSrc": ""
                },
                "columns": [
                    { "data": "id" },
                    { "data": "name" },
                    { "data": "salary" },
                    { "data": "deptName" },
                    { "data": "date" },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            
                            return '<button class="btn btn-primary editBtn" data-id="' + row.id + '"><i class="fa-solid fa-pen-to-square"></i></button> ' +
                                '<button class="btn btn-danger deleteBtn" data-id="' + row.id + '"><i class="fa-solid fa-trash-can"></i></button> ' +
                                '<button class="btn btn-success downloadBtn" data-id="' + row.id + '"><i class="fa-regular fa-circle-down"></i></button>';
                        }
                    }
                ]
            });


            $('#searchButton').click(function () {
                var searchValue = $('#searchInput').val();
                dataTable.search(searchValue).draw();
            });


            function isValidDecimalNumber(value) {
                var decimalPattern = /^-?\d+(\.\d+)?$/;
                return decimalPattern.test(value);
            }


            $('#createForm').submit(function (e) {
                e.preventDefault();

                var employeeId = $('#employeeId').val();
                var employeeName = $('#employeeName').val();
                var employeeSalary = $('#employeeSalary').val();
                //var date = $('#date').val();


                if (!isValidDecimalNumber(employeeSalary)) {
                    alert('Please enter a valid decimal number for the price.');
                    return;
                }


                var salaryFloat = parseFloat(employeeSalary);

                var employeeDpt = $('#employeeDpt').val();
                var cDate = $('#cDate').val();

                var employeeData = {
                    empname: employeeName,
                    salary: salaryFloat,
                    certificateId: parseInt(cDate),
                    deptId: parseInt(employeeDpt),

                };
                var apiUrl = 'http://localhost:5251/api/Employee/';
                var httpMethod, successMessage;
                if (employeeId === '') {
                    httpMethod = 'POST';
                    successMessage = 'Employee created successfully.';
                } else {
                    httpMethod = 'PUT';
                    apiUrl += employeeId;
                    successMessage = 'Employee updated successfully.';
                }

                $.ajax({
                    url: apiUrl,
                    type: httpMethod,
                    method: httpMethod,
                    contentType: 'application/json',
                    data: JSON.stringify(employeeData),
                    success: function () {
                        alert(successMessage);
                        $('#employeeId').val('');
                        $('#employeeName').val('');
                        $('#employeeSalary').val('');
                        $('#employeeDpt').val('');
                        $('#cDate').val('');
                        dataTable.ajax.reload();


                        $('#saveButton').text('Save');
                    },
                    error: function (error) {
                        console.error(error);
                    }
                });
            });


            $('#employeeTable').on('click', '.editBtn', function () {
                var employeeId = $(this).data('id');
                console.log('Editing employee with ID: ' + employeeId);
                $.ajax({
                    url: 'http://localhost:5251/api/Employee/' + employeeId,
                    type: 'GET',
                    success: function (employee) {
                        $('#employeeId').val(employeeId);
                        $('#employeeName').val(employee.name);
                        $('#employeeSalary').val(employee.salary);
                        $('#employeeDpt').val(employee.deptId);
                        $('#cDate').val(employee.certificateId);



                        $('#saveButton').text('Update');
                    },
                    error: function (error) {
                        console.error(error);
                    }
                });
            });




            $('#employeeTable').on('click', '.deleteBtn', function () {
                var employeeId = $(this).data('id');
                if (confirm('Are you sure you want to delete this certificate?')) {
                    $.ajax({
                        url: 'http://localhost:5251/api/Employee/' + employeeId,
                        type: 'DELETE',
                        success: function () {
                            dataTable.ajax.reload();
                        },
                        error: function (error) {
                            console.error(error);
                        }
                    });
                }
            });


            $('#clearButton').click(function () {
                $('#employeeId').val('');
                $('#employeeName').val('');
                $('#employeeSalary').val('');
                $('#employeeDpt').val('');
                $('#cDate').val('');


                $('#saveButton').text('Save');
            });


            $('#employeeTable').on('click', '.downloadBtn', function () {
                var employeeId = $(this).data('id');

                // Perform AJAX request to get employee details by ID
                $.ajax({
                    url: 'http://localhost:5251/api/Employee/' + employeeId,
                    type: 'GET',
                    success: function (employee) {
                        // Create a new PDF document
                        var pdf = new jsPDF();

                        // Add certificate header
                        pdf.setFontSize(18);
                        pdf.setTextColor(44, 62, 80); // Dark blue color
                        pdf.text('Certificate of Employment', 20, 20, { align: 'center' });

                        // Add employee details with a certificate-style layout
                        pdf.setFontSize(14);
                        pdf.setTextColor(52, 73, 94); // Dark gray color
                        pdf.text('This is to certify that', 20, 40);
                        pdf.setTextColor(44, 62, 80); // Dark blue color
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(employee.name, 20, 55, { align: 'center' });
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(52, 73, 94); // Dark gray color
                        pdf.text('has been employed with our company in Department', 20, 70);
                        pdf.setFont('helvetica', 'italic');
                        pdf.text('[' + employee.deptName + ']', 20, 85, { align: 'center' });
                        pdf.setFont('helvetica', 'normal');
                        pdf.text('since', 20, 100);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(44, 62, 80); // Dark blue color
                        pdf.text(employee.date, 70, 100);
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(52, 73, 94); // Dark gray color
                        pdf.text('Salary: $' + employee.salary, 20, 115);

                        // Add signature line
                        pdf.text('______________________________', 20, 150);

                        // Save the PDF with a meaningful filename
                        pdf.save('Certificate_of_Employment_' + employee.name + '.pdf');
                    },
                    error: function (error) {
                        console.error(error);
                    }
                });
            });

            var storedData = JSON.parse(localStorage.getItem('employeeFormData'));

            if (storedData) {
                $('#employeeId').val(storedData.employeeId);
                $('#employeeName').val(storedData.employeeName);
                $('#employeeSalary').val(storedData.employeeSalary);
                $('#employeeDpt').val(storedData.employeeDpt);
                $('#cDate').val(storedData.cDate);
                $('#saveButton').text(storedData.saveButtonText);
            }


            
        });

        



        
        $(window).on('beforeunload', function () {
            var employeeData = {
                employeeId: $('#employeeId').val(),
                employeeName: $('#employeeName').val(),
                employeeSalary: $('#employeeSalary').val(),
                employeeDpt: $('#employeeDpt').val(),
                cDate: $('#cDate').val(),
                saveButtonText: $('#saveButton').text(),
            };

            localStorage.setItem('employeeFormData', JSON.stringify(employeeData));
        })


    





    </script>
</body>
</html>
